name: asr-tts-curator

services:
  db:
    image: mysql:9
    container_name: "mysql-db"
    secrets:
      - db_root_password
      - db_password
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=${MYSQL_ROOT_PASSWORD_FILE}
      - MYSQL_PASSWORD_FILE=${MYSQL_PASSWORD_FILE}
    env_file:
      - ./.env
    ports:
      - ${MYSQL_PORT}:${MYSQL_PORT}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER}", "-p${MYSQL_PASSWORD}"]
      start_period: 10s
      interval: 10s
      timeout: 30s
      retries: 5
    networks:
      - data-collection-net

  app:
    container_name: "curator-app"
    image: docker.io/kameldin/asr-tts-curator:0.1
    secrets:
      - hf_token
      - aws_access_id
      - aws_access_secret
      - db_password
    environment:
      - HUGGINGFACE_TOKEN_FILE=${HUGGINGFACE_TOKEN_FILE}
      - AWS_ACCESS_KEY_ID_FILE=${AWS_ACCESS_KEY_ID_FILE}
      - AWS_SECRET_ACCESS_KEY_FILE=${AWS_SECRET_ACCESS_KEY_FILE}
      - MYSQL_PASSWORD_FILE=${MYSQL_PASSWORD_FILE}
    env_file:
      - ./.env
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - APP_PORT=$APP_PORT
    ports:
      - ${APP_PORT}:${APP_PORT}
    volumes:
      - type: bind
        source: ./logs.log
        target: /app/backend/logs.log

      - type: bind
        source: ./recordings
        target: /app/backend/recordings
      
    networks:
      - data-collection-net
    develop:
      watch:
        - action: rebuild
          path: ./backend/
          target: /app/backend

        - action: rebuild
          path: ./frontend/
          target: /app/backend
          
    depends_on:
      db:
        condition: service_healthy

networks:
  data-collection-net: {}

secrets:
  hf_token:
    file: ./secrets/hf_token.txt
  db_password:
    file: ./secrets/db_password.txt
  db_root_password:
    file: ./secrets/db_root_password.txt
  aws_access_id:
    file: ./secrets/aws_access_id.txt
  aws_access_secret:
    file: ./secrets/aws_access_secret.txt


volumes:
  recordings:
    external: true


    